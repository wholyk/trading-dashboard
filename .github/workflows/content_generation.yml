name: Content Generation

on:
  workflow_dispatch:  # Triggered by viral detection
  
env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}

jobs:
  generate-content:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        # Scale factor from config (1, 3, or 10 jobs in parallel)
        job_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      fail-fast: false  # Continue other jobs if one fails
      max-parallel: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download approved ideas
        uses: actions/download-artifact@v3
        with:
          name: approved-ideas
          path: data/
      
      - name: Load scale factor and check if job should run
        id: check-scale
        run: |
          SCALE_FACTOR=$(yq eval '.scaling.scale_factor' config/system_config.yaml)
          JOB_ID=${{ matrix.job_id }}
          
          if [ $JOB_ID -le $SCALE_FACTOR ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Job $JOB_ID skipped (scale factor: $SCALE_FACTOR)"
          fi
      
      - name: Get idea for this job
        if: steps.check-scale.outputs.should_run == 'true'
        id: get-idea
        run: |
          JOB_ID=${{ matrix.job_id }}
          IDEA=$(jq -r ".[$JOB_ID - 1] // empty" data/idea_queue.json)
          
          if [ -z "$IDEA" ]; then
            echo "has_idea=false" >> $GITHUB_OUTPUT
            echo "No idea available for job $JOB_ID"
          else
            echo "has_idea=true" >> $GITHUB_OUTPUT
            echo "$IDEA" > /tmp/idea_$JOB_ID.json
          fi
      
      - name: Generate script
        if: steps.get-idea.outputs.has_idea == 'true'
        id: generate-script
        run: |
          python src/generation/script_generator.py \
            --idea-file /tmp/idea_${{ matrix.job_id }}.json \
            --output-file /tmp/script_${{ matrix.job_id }}.json
          echo "script_generated=$?" >> $GITHUB_OUTPUT
      
      - name: Generate visuals
        if: steps.generate-script.outputs.script_generated == '0'
        id: generate-visuals
        run: |
          python src/generation/visual_generator.py \
            --script-file /tmp/script_${{ matrix.job_id }}.json \
            --output-file /tmp/video_${{ matrix.job_id }}.mp4
          echo "video_generated=$?" >> $GITHUB_OUTPUT
      
      - name: Generate captions and metadata
        if: steps.generate-visuals.outputs.video_generated == '0'
        id: generate-metadata
        run: |
          python src/generation/caption_generator.py \
            --script-file /tmp/script_${{ matrix.job_id }}.json \
            --video-file /tmp/video_${{ matrix.job_id }}.mp4 \
            --output-file /tmp/metadata_${{ matrix.job_id }}.json
          echo "metadata_generated=$?" >> $GITHUB_OUTPUT
      
      - name: Run quality validation
        if: steps.generate-metadata.outputs.metadata_generated == '0'
        id: quality-check
        run: |
          python src/generation/quality_validator.py \
            --video-file /tmp/video_${{ matrix.job_id }}.mp4 \
            --metadata-file /tmp/metadata_${{ matrix.job_id }}.json
          echo "quality_passed=$?" >> $GITHUB_OUTPUT
      
      - name: Save generated video
        if: steps.quality-check.outputs.quality_passed == '0'
        uses: actions/upload-artifact@v3
        with:
          name: video-job-${{ matrix.job_id }}
          path: |
            /tmp/video_${{ matrix.job_id }}.mp4
            /tmp/metadata_${{ matrix.job_id }}.json
          retention-days: 7
      
      - name: Save failed video for review
        if: steps.quality-check.outputs.quality_passed != '0' && steps.generate-visuals.outputs.video_generated == '0'
        uses: actions/upload-artifact@v3
        with:
          name: failed-qa-job-${{ matrix.job_id }}
          path: |
            /tmp/video_${{ matrix.job_id }}.mp4
            /tmp/quality_report_${{ matrix.job_id }}.json
          retention-days: 7
      
      - name: Job summary
        if: always() && steps.check-scale.outputs.should_run == 'true'
        run: |
          echo "## Job ${{ matrix.job_id }} Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Idea loaded: ${{ steps.get-idea.outputs.has_idea }}" >> $GITHUB_STEP_SUMMARY
          echo "- Script generated: ${{ steps.generate-script.outputs.script_generated == '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Video generated: ${{ steps.generate-visuals.outputs.video_generated == '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quality passed: ${{ steps.quality-check.outputs.quality_passed == '0' }}" >> $GITHUB_STEP_SUMMARY
  
  trigger-upload:
    needs: generate-content
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Count successful videos
        id: count-success
        uses: actions/github-script@v6
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const videoArtifacts = artifacts.data.artifacts.filter(a => 
              a.name.startsWith('video-job-')
            );
            
            console.log(`${videoArtifacts.length} videos ready for upload`);
            core.setOutput('video_count', videoArtifacts.length);
      
      - name: Trigger upload workflow
        if: steps.count-success.outputs.video_count > 0
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'upload_automation.yml',
              ref: context.ref,
              inputs: {
                run_id: context.runId.toString()
              }
            });
      
      - name: Create alert if all failed
        if: steps.count-success.outputs.video_count == 0
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Content Generation Failed - No Videos Produced',
              body: `All content generation jobs failed to produce valid videos.
              
              **Run:** ${context.runId}
              
              Please check:
              1. API credentials (OpenAI, Pexels)
              2. System dependencies (FFmpeg)
              3. Quality validation logs`,
              labels: ['alert', 'content-generation']
            });
